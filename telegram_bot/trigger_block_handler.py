#!/usr/bin/env python3
"""
üö´ –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø
"""

import logging
from telegram import Update
from telegram.ext import CallbackContext

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ python-telegram-bot
try:
    from telegram.ext import ApplicationHandlerStop
except ImportError:
    # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π python-telegram-bot
    class ApplicationHandlerStop(Exception):
        """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö telegram-bot"""
        pass

logger = logging.getLogger(__name__)

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å
TRIGGER_BLOCK_MESSAGE = "üö´ –í–∞—à –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"

def handle_trigger_block_message(update: Update, context: CallbackContext):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    –õ–æ–≥–∏–∫–∞:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–º
    2. –ï—Å–ª–∏ –¥–∞ - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    3. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not update.message or not update.message.text:
            return  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞
        
        user_id = update.effective_user.id
        message_text = update.message.text.strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if message_text == TRIGGER_BLOCK_MESSAGE:
            logger.info(f"üö´ –¢–†–ò–ì–ì–ï–† –ë–õ–û–ö–ò–†–û–í–ö–ò: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ–ª—É—á–∏–ª —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            
            # –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                from telegram_bot.middleware.smart_access_check import force_block_user
                force_block_user(user_id)
                logger.info(f"üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä")
                
            except ImportError:
                logger.warning("Smart access check –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º access_manager
            try:
                from utils.access_manager import remove_user_access
                remove_user_access(user_id)
                logger.info(f"üóëÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É–¥–∞–ª–µ–Ω –∏–∑ access_manager")
                
            except ImportError:
                logger.warning("Access manager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
            try:
                update.message.reply_text(
                    "üö´ –í–∞—à –¥–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.\n\n"
                    "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
                    parse_mode='HTML'
                )
                logger.info(f"üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
            logger.info(f"üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            raise ApplicationHandlerStop
            
    except ApplicationHandlerStop:
        # –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        raise
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: {e}")
        # –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ 